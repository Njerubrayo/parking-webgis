<!DOCTYPE html>
<html>
<head>
    <title>ParkPoa Map</title>
    <meta charset="utf-8" />
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', sans-serif;
        }

        .navbar {
            background-color: #2e7d32;
            color: white;
            padding: 1rem 2rem;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-content {
            display: flex;
            height: calc(100% - 60px); /* navbar height */
        }

        .sidebar {
            width: 300px;
            background-color: #2f2f2f;
            color: white;
            padding: 2rem 1.5rem;
        }

        .sidebar h2 {
            font-size: 1.4rem;
            margin-bottom: 1rem;
            color: #ffc107;
        }

        #map {
            flex: 1;
            height: 100%;
        }

        .logout-btn {
            background: linear-gradient(135deg, #f44336, #e53935);
            border: none;
            color: white;
            padding: 10px 18px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                text-align: center;
            }
            #map {
                height: 70vh;
            }
        }
    </style>
</head>

<body>
    <div class="navbar">
        ParkPoa
        <form method="POST" action="/logout/">
            {% csrf_token %}
            <button type="submit" class="logout-btn">Logout</button>
        </form>
    </div>

    <div class="main-content">
        <div class="sidebar">
            <h2>Where can we help you park?</h2>
        </div>
        <div id="map"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
        const map = L.map('map', {
            maxZoom: 22,
            zoomControl: true
        }).setView([-1.3, 36.8], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data Â© OpenStreetMap contributors',
            maxZoom: 22,
            maxNativeZoom: 19
        }).addTo(map);

     
    const currentBookingId = {{ current_booking_id|default:"null" }};

    fetch("/api/parkinglots/")
        .then(response => response.json())
        .then(data => {
            const geojsonLayer = L.geoJSON(data, {
                onEachFeature: function (feature, layer) {
                    const props = feature.properties;
                    let popupHtml = `<strong>Slot Number:</strong> ${props.slot_no}<br>`;

                    if (feature.id === currentBookingId) {
                        // This slot is booked by the current user
                        popupHtml += `
                            <form method="POST" action="/release/${feature.id}/">
                                <input type="hidden" name="slot_id" value="${feature.id}">
                                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                <button type="submit" style="
                                    margin-top: 8px;
                                    background: #f44336;
                                    color: white;
                                    border: none;
                                    padding: 6px 12px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                ">
                                    Release Slot
                                </button>
                            </form>`;
                    } else if (props.status !== 'occupied') {
                        // Slot is available
                        popupHtml += `
                            <a href="/book/${feature.id}/">
                                <button style="
                                    margin-top: 10px;
                                    background: linear-gradient(135deg, #4CAF50, #388E3C);
                                    color: white;
                                    border: none;
                                    padding: 8px 16px;
                                    border-radius: 8px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    transition: 0.3s;
                                " onmouseover="this.style.transform='scale(1.05)'"
                                  onmouseout="this.style.transform='scale(1)'">
                                    Book Slot
                                </button>
                            </a>`;
                    } else {
                        popupHtml += `<span style="color: red;">Occupied</span>`;
                    }

                    layer.bindPopup(popupHtml);
                },
                style: function (feature) {
                    const isUserSlot = feature.id === currentBookingId;
                    const status = feature.properties.status;

                    return {
                         color: isUserSlot ? '#0000FF' : '#0077ff',
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 0.6,
                        fillColor: status === 'occupied' ? '#ff5555' : '#55ff55'
                    };
                }
            });

            geojsonLayer.addTo(map);
        });
</script>




                    },
                    style: function (feature) {
                        const status = feature.properties.status;
                        return {
                            color: "#0077ff",
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.6,
                            fillColor: status === 'occupied' ? '#ff5555' : '#55ff55'
                        };
                    }
                });

                geojsonLayer.addTo(map);

                if (geojsonLayer.getBounds().isValid()) {
                    map.fitBounds(geojsonLayer.getBounds(), {
                        padding: [20, 20],
                        maxZoom: 20
                    });
                }
            });

       
        function getCSRFToken() {
            let cookieValue = null;
            const name = 'csrftoken';
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        function bookSlot(slotId) {
    alert(`Booking slot #${slotId}... (this will later trigger a booking request or page)`);

    // In real use, you can redirect or send POST to booking API
    // Example redirect to booking page:
    // window.location.href = `/book/${slotId}/`;
}

    </script>
</body>
</html>
